<!-- Reference screenshot (local): /mnt/data/e1bae5cc-099c-41dd-81c5-c17c9a8a01e5.png -->
{% extends "base.html" %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Estimate | Manual Billing System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{ --primary:#007bff; --soft-bg:#f4f6f9; }
    html,body{height:100%;width:100%;margin:0;padding:0;background:var(--soft-bg);font-family:'Segoe UI',system-ui,Arial;box-sizing:border-box;-webkit-font-smoothing:antialiased}

    /* full viewport wrapper */
    .page-wrap{min-height:100vh;height:100vh;display:flex;align-items:stretch;justify-content:center;padding:0;background:var(--soft-bg)}

    /* use a visual card that fills viewport height but keeps content scrollable */
    .card{width:100%;height:100%;max-width:980px;margin:0;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,0.08)}

    /* header sticks to top inside card */
    .card-header{background:var(--primary);color:#fff;padding:10px 14px;font-weight:700;flex:0 0 auto}
    .card-body{padding:12px;overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1 1 auto}

    /* responsive stacks */
    .stack-on-mobile{display:flex;gap:12px;align-items:end}
    @media (max-width:720px){ .stack-on-mobile{flex-direction:column;align-items:stretch} }

    /* table responsiveness */
    .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch}

    /* hide columns on very small screens */
    @media (max-width:420px){ .hide-xs{display:none} }

    /* controls/tap sizes */
    .btn{min-height:44px}

    /* remove outer container margins that could cause centering small box */
    .container, .page-wrap, .card { margin-left:0 !important; margin-right:0 !important; padding-left:0 !important; padding-right:0 !important }

    /* small device fine-tune */
    @media (max-width:420px){ .card{border-radius:8px} .card-header{padding:10px} .card-body{padding:10px} }

    /* safe-area */
    body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}

    /* helper for totals area on small screens */
    .text-end-mobile { text-align:right; }
    @media (max-width:480px){ .text-end-mobile { text-align:left; } }

    /* helper classes for print-only / no-print */
    .no-print { display: inline-block; }
    .print-only { display: none; }

    /* ---------- PRINT OPTIMIZATIONS ---------- */
    @page { size: A4; margin: 0; }
    html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    @media print {
      html, body, .page-wrap, .card { height: auto !important; min-height: 0 !important; max-height: none !important; overflow: visible !important; margin: 0 !important; padding: 0 !important; background: #fff !important; box-shadow: none !important; border-radius: 0 !important; }
      .card { width: 210mm !important; max-width: 210mm !important; margin: 6mm auto !important; border: 1px solid #000 !important; box-sizing: border-box !important; }
      .card-body { overflow: visible !important; -webkit-overflow-scrolling: auto !important; padding: 8mm !important; }

      /* hide interactive controls on print */
      button, .btn, input, textarea, select, .muted-small, .no-print { display: none !important; }
      .print-only { display: inline !important; }

      /* tables: avoid page-break inside rows */
      table { border-collapse: collapse; }
      tr, td, th { page-break-inside: avoid !important; }

      /* ensure background and borders print nicely */
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      /* page break helper */
      .page-break { page-break-before: always; break-before: page; }

      .text-end-mobile { text-align: right !important; }
    }
    /* ---------- END PRINT OPTIMIZATIONS ---------- */
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="card" role="main">
      <div class="card-header">
        <h4 class="mb-0" style="font-size:1rem;">üìã Create Estimate</h4>
      </div>

      <div class="card-body">

        <!-- Customer Details -->
        <h5 class="text-primary mb-2">Customer Details</h5>
        <div class="row g-2">
          <div class="col-12 col-sm-6 col-md-3">
            <label class="form-label">Customer Name</label>
            <input type="text" class="form-control no-print" id="customer_name_input" value="{{ bill.customer_name }}" readonly>
            <div class="print-only" id="customer_name_print">{{ bill.customer_name }}</div>
          </div>
          <div class="col-12 col-sm-6 col-md-3">
            <label class="form-label">Mobile</label>
            <input type="tel" class="form-control no-print" id="customer_phone_input" value="{{ bill.phone }}" readonly>
            <div class="print-only" id="customer_phone_print">{{ bill.phone }}</div>
          </div>
          <div class="col-12 col-sm-6 col-md-3">
            <label class="form-label">Date</label>
            <input type="text" class="form-control no-print" id="bill_date_input" value="{{ bill.date }}" readonly>
            <div class="print-only" id="bill_date_print">{{ bill.date }}</div>
          </div>
          <div class="col-12 col-sm-6 col-md-3">
            <label class="form-label">Bill No</label>
            <input type="text" class="form-control no-print" id="bill_no_input" value="{{ bill.bill_no }}" readonly>
            <div class="print-only" id="bill_no_print">{{ bill.bill_no }}</div>
          </div>
        </div>

        <hr>

        <!-- Add Product -->
        <h5 class="text-primary mb-2">Add Product Details</h5>
        <div id="product-form" class="stack-on-mobile">
          <div class="flex-grow-1"><label class="form-label">Code</label><input id="product_code" class="form-control" placeholder="Enter Code (optional)"></div>
          <div class="flex-grow-2"><label class="form-label">Product Name</label><input id="product_name" class="form-control" placeholder="Enter Product Name" autocomplete="off"></div>
          <div style="width:100px;min-width:90px"><label class="form-label">Qty</label><input id="quantity" type="number" inputmode="numeric" class="form-control" min="1"></div>
          <div style="width:110px;min-width:90px"><label class="form-label">Rate</label><input id="rate" type="number" inputmode="decimal" class="form-control" step="0.01"></div>
          <div style="width:100px;min-width:80px"><label class="form-label">Total</label><input id="total" class="form-control" readonly></div>
          <div style="width:56px;min-width:56px" class="d-flex align-items-end"><button class="btn btn-success w-100" type="button" onclick="addProduct()">‚ûï</button></div>
        </div>

        <hr>

        <!-- Product List -->
        <h5 class="text-primary mb-2">Product List</h5>
        <div class="table-responsive mb-2">
          <table class="table table-sm table-bordered mb-0" id="product-table">
            <thead>
              <tr>
                <th class="hide-xs">Code</th>
                <th>Product</th>
                <th>Qty</th>
                <th class="hide-xs">Rate</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <hr>

        <!-- Payment Summary -->
        <div class="row g-2 align-items-end">
          <div class="col-12 col-sm-6 col-md-3"><label class="form-label">Extra Charge / Reason</label><input id="reason" class="form-control no-print" placeholder="e.g. Service, Discount"><div class="print-only" id="reason_print"></div></div>
          <div class="col-6 col-sm-3 col-md-2"><label class="form-label">Packing Qty</label><input id="packing_qty" type="number" class="form-control no-print" min="0" value="0"><div class="print-only" id="packing_qty_print">0</div></div>
          <div class="col-6 col-sm-3 col-md-2"><label class="form-label">Packing Rate</label><input id="packing_rate" type="number" class="form-control no-print" step="0.01" min="0" value="0"><div class="print-only" id="packing_rate_print">0.00</div></div>
          <div class="col-12 col-sm-6 col-md-3"><label class="form-label">Packing Reason (optional)</label><input id="packing_reason" class="form-control no-print" placeholder="e.g. Fragile packing"><div class="print-only" id="packing_reason_print"></div></div>
          <div class="col-12 col-sm-6 col-md-2"><label class="form-label">Packing Total</label>
            <input id="packing_total" class="form-control no-print" readonly value="0.00">
            <div class="muted-small mt-1 no-print">(qty √ó rate)</div>
            <div class="print-only" id="packing_total_print">0.00</div>
          </div>
        </div>

        <div class="text-end-mobile mt-3">
          <h5 class="fw-bold">Total (Without Packing): ‚Çπ<span id="grand-total">0.00</span></h5>
          <h5 class="fw-bold text-success">Final Total (With Packing): ‚Çπ<span id="final-total">0.00</span></h5>
        </div>

        <div class="mt-3 d-flex gap-2 justify-content-end">
          <button class="btn btn-primary px-4 no-print" type="button" onclick="saveAndGenerate()">üíæ Save & Generate Bill</button>
          <!-- Back button replaced with JS-backed button to ensure it works even if history is empty -->
          <button class="btn btn-secondary px-4 no-print" type="button" onclick="goBack()">‚¨Ö Back</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    function debounce(fn,ms=120){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}} 
    let products=[];
    const rateEl=document.getElementById('rate'), qtyEl=document.getElementById('quantity'), pqEl=document.getElementById('packing_qty'), prEl=document.getElementById('packing_rate');
    if(rateEl) rateEl.addEventListener('input',debounce(updateTotal,80)); if(qtyEl) qtyEl.addEventListener('input',debounce(updateTotal,80)); if(pqEl) pqEl.addEventListener('input',debounce(updateFinalTotal,80)); if(prEl) prEl.addEventListener('input',debounce(updateFinalTotal,80));
    function updateTotal(){const q=parseFloat(document.getElementById('quantity').value)||0;const r=parseFloat(document.getElementById('rate').value)||0;document.getElementById('total').value=(q*r).toFixed(2)}
    function addProduct(){const code=document.getElementById('product_code').value.trim();const name=document.getElementById('product_name').value.trim();const qty=parseFloat(document.getElementById('quantity').value)||0;const rate=parseFloat(document.getElementById('rate').value)||0;const total=qty*rate;if(!name){alert('‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§');return}if(qty<=0||isNaN(qty)){alert('‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§®‡•ç‡§Ø quantity ‡§°‡§æ‡§≤‡•á‡§Ç‡•§');return}if(rate<0||isNaN(rate)){alert('‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§®‡•ç‡§Ø rate ‡§°‡§æ‡§≤‡•á‡§Ç‡•§');return}products.push({code:code||'',name,qty,rate,total});renderTable();resetForm();}
    function renderTable(){const tbody=document.querySelector('#product-table tbody');tbody.innerHTML='';let grand=0;products.forEach((it,i)=>{grand+=it.total;tbody.insertAdjacentHTML('beforeend',`<tr><td class="hide-xs">${it.code||'-'}</td><td>${escapeHtml(it.name)}</td><td>${it.qty}</td><td class="hide-xs">‚Çπ${Number(it.rate).toFixed(2)}</td><td>‚Çπ${Number(it.total).toFixed(2)}</td><td><button class="btn btn-danger btn-sm" onclick="removeProduct(${i})">üóëÔ∏è</button></td></tr>`)});document.getElementById('grand-total').textContent=grand.toFixed(2);updateFinalTotal()}
    function updateFinalTotal(){const grand=parseFloat(document.getElementById('grand-total').textContent)||0;const pq=parseFloat(document.getElementById('packing_qty').value)||0;const pr=parseFloat(document.getElementById('packing_rate').value)||0;const packing=pq*pr;document.getElementById('packing_total').value=packing.toFixed(2);document.getElementById('final-total').textContent=(grand+packing).toFixed(2)}
    function removeProduct(idx){products.splice(idx,1);renderTable()}function resetForm(){document.getElementById('product_code').value='';document.getElementById('product_name').value='';document.getElementById('quantity').value='';document.getElementById('rate').value='';document.getElementById('total').value=''}
    function escapeHtml(s){if(!s) return '';return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;")}
    async function saveAndGenerate(){const extra=document.getElementById('reason').value.trim();const packingQty=parseFloat(document.getElementById('packing_qty').value)||0;const packingRate=parseFloat(document.getElementById('packing_rate').value)||0;const packingReason=document.getElementById('packing_reason').value.trim();const packing=packingQty*packingRate;if(products.length===0){alert('‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§');return}const payload={items:products.map(p=>({code:p.code,description:p.name,quantity:p.qty,rate:p.rate,total:p.total})),packing_qty:packingQty,packing_rate:packingRate,packing:packing,reason:extra,packing_reason:packingReason};try{const response=await fetch(window.location.href,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},body:JSON.stringify(payload)});const result=await response.json().catch(()=>({success:false}));if(result.success){alert('‚úÖ Estimate saved successfully!');window.location.href=`/generate-bill/{{ bill.id }}/`}else{alert('‚ùå Error saving estimate! Please try again.')} }catch(e){console.error(e);alert('‚ùå Network error while saving. Check console.')} }

    /* Prepare print-only fields from inputs before printing */
    function preparePrintFields(){
      // customer details
      const nameInput=document.getElementById('customer_name_input'); if(nameInput) document.getElementById('customer_name_print').innerText = nameInput.value || '';
      const phoneInput=document.getElementById('customer_phone_input'); if(phoneInput) document.getElementById('customer_phone_print').innerText = phoneInput.value || '';
      const dateInput=document.getElementById('bill_date_input'); if(dateInput) document.getElementById('bill_date_print').innerText = dateInput.value || '';
      const billNoInput=document.getElementById('bill_no_input'); if(billNoInput) document.getElementById('bill_no_print').innerText = billNoInput.value || '';

      // packing & reason
      const reason=document.getElementById('reason'); if(reason) document.getElementById('reason_print').innerText = reason.value || '';
      const pq=document.getElementById('packing_qty'); if(pq) document.getElementById('packing_qty_print').innerText = pq.value || '0';
      const pr=document.getElementById('packing_rate'); if(pr) document.getElementById('packing_rate_print').innerText = (parseFloat(pr.value)||0).toFixed(2);
      const packingTotal=document.getElementById('packing_total'); if(packingTotal) document.getElementById('packing_total_print').innerText = packingTotal.value || '0.00';

      // totals
      const grand=document.getElementById('grand-total'); const finalTotal=document.getElementById('final-total');
      if(grand) { document.getElementById('grand-total').innerText = (parseFloat(grand.textContent)||0).toFixed(2); }
      if(finalTotal) { document.getElementById('final-total').innerText = (parseFloat(finalTotal.textContent)||0).toFixed(2); }

      // For product table: nothing required as table rows are already present in DOM.
    }

    // goBack helper: first try history.back(), otherwise fall back to home URL
    function goBack(){
      try{
        if(window.history && window.history.length>1){ window.history.back(); return; }
      }catch(e){}
      // fallback
      window.location.href = "{% url 'home' %}";
    }

    // Hook print events
    if (window.matchMedia) {
      window.addEventListener('beforeprint', preparePrintFields);
      window.addEventListener('afterprint', function(){ /* nothing to restore */ });
    } else {
      // Fallback for browsers without matchMedia
      window.onbeforeprint = preparePrintFields;
      window.onafterprint = function(){};
    }
  </script>
</body>
</html>
